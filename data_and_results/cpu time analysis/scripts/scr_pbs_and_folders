#!/bin/bash
set -euo pipefail

# Loop REP from 1 to 10
for REP in $(seq 1 10); do
  echo "Generating for REP=${REP}"

  # Create folder and copy master contents
  DIR="s${REP}_batch"
  mkdir -p "${DIR}"
  cp -r master/* "${DIR}"

  # Compute final argument: 100 * REP
  FINAL_ARG=$((101 * REP))

  # Write desrail.pbs into the folder
  cat > "${DIR}/desrail.pbs" <<PBS
#!/bin/bash -l
#PBS -N desrail_job
#PBS -q cpu_batch
#PBS -l select=1:ncpus=1:mem=1gb
#PBS -l walltime=04:00:00
#PBS -j oe

set -euo pipefail
cd "\$PBS_O_WORKDIR"

# Force single-threading
export OMP_NUM_THREADS=1 OPENBLAS_NUM_THREADS=1 MKL_NUM_THREADS=1

./desrail 20 100000 100 ${FINAL_ARG}
PBS

  chmod +x "${DIR}/desrail.pbs"
done

